<html>
<!--  TODO ygiri
Provide option to show only a section of the graph, e.g., all descendants of a person / couple
-->
<head>
    <title>The Shared Family Community Tree</title>
</head>

<meta charset="utf-8">
<style>

.link {
  stroke: #ccc;
  stroke-width: 2.5px;
}

.node text {
  pointer-events: none;
  font: 14px sans-serif;
}

</style>
<body>

<!--   <a href="viewFamily">View Family Tree</a> &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp -->
<!--   <a href="viewExtendedFamily">View Extended Family Tree</a> &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp -->
  <a href="editFamily">Edit Family Tree</a> 

<div id="tree">
  
<script src="//d3js.org/d3.v3.min.js"></script>
<script>

	var width = 1300,
	    height = 1700,
	    color = d3.scale.category20c();
// 	    shape = d3.scaleOrdinal(d3.symbols);
	
	var svg = d3.select("body").append("svg")
	    .attr("width", width)
	    .attr("height", height);
	
	var force = d3.layout.force()
	    .gravity(0.05)
	    .distance(100)
	    .charge(-300)
	    .size([width, height]);
	
// 		svg.append("svg:defs").selectAll("marker") 
// 			.data(["end"]) 
// 			.attr("id", String) 
// 			.enter().append("svg:marker") 
// 			.attr("viewBox", "0 -5 10 10") 
// 			.attr("refX", 15) 
// 			.attr("refY", -1.5) 
// 			.attr("markerWidth", 6) 
// 			.attr("markerHeight", 6) .attr("orient", "auto") .append("svg:path") .attr("d", "M0,-5L10,0L0,5");
	
	// AJAX call back to get the tree data
	var json;
	d3.json("/viewFamilyData", function(error, data) {
	  if (error) throw error;
	  json = data;
	  update();
	});
	
	function update() {
	  force
	      .nodes(json.nodes)
	      .links(json.links)
	      .charge(function(d) { if
				(d.label == 'parent') { return 0; } else { return -300;}
			})
	      .linkDistance(function(d) { if
  				(d.label == 'parent') { return 0; } else { return 100;}
			})
	      .start();
	
	  var link = svg.selectAll(".link")
	      .data(json.links)
	    .enter().append("line")
	      .attr("class", "link")
	      .style("stroke-width", function(d) { if
				(d.label == 'parent') { return '4.5px'; } else { return '1.5px';}
			})
      		.style("stroke", function(d) { return color(d.familyid);
				});
	
	  var node = svg.selectAll(".node")
	      .data(json.nodes)
	    .enter().append("g")
	      .attr("class", "node")
	      .on("click", click)
	      .call(force.drag);
	
	//	  node.append("image")
	//      .attr("xlink:href", "https://github.com/favicon.ico")
	//      .attr("x", -8)
	//      .attr("y", -8)
	//      .attr("width", 16)
	//      .attr("height", 16);
	
// 	        node.append("circle")
// 	                .attr("r", 10)
// 	                .call(force.drag);
	
	        node.append("path")
	                //.attr("d", d3.symbol().type( function(d) { return shape(d.label);} ) )
	                .attr("d", d3.svg.symbol()
                 		.size(function(d) { if
        					(d.label == 'family') { return 10000; } else { return 100;}
      					})
                 		.type(function(d) { if(d.label == 'family') { return "circle"; } 
                 				else if (d.gender == 'Female') { return "diamond";}
                 				else { return "square";}
                  			}))
	                .style("stroke", function(d) { return color(d.familyid);
          					})
	                .style("fill", function(d) { if
            					(d.label == 'family') { return "none"; } else if (d.gender == 'Female') { return "pink";}
                 				else { return "gray";}
          					})
// 	                .style("fill", function(d) {return color(d.label);
//           					})
//           			.attr("marker-end", "url(#end)")
	                .call(force.drag);
	        
// 	        svg.selectAll(".link") .attr("marker-end", "url(#end)");
	        
	  node.append("text")
	      .attr("dx", 14)
	      .attr("dy", ".35em")
	      .style('font-weight', function(d) { if
				(d.label == 'family') { return 'bold'; } else { return '';}
			})
	      .text(function(d) { return d.name });
	
	  force.on("tick", function() {
	    link.attr("x1", function(d) { return d.source.x; })
	        .attr("y1", function(d) { return d.source.y; })
	        .attr("x2", function(d) { return d.target.x; })
	        .attr("y2", function(d) { return d.target.y; });
	
	    node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
	  });
	}
	
	// Toggle children on click.
	function click(d) {
		console.log("node clicked")
	  if (d3.event.defaultPrevented) return; // ignore drag
	  if (d.children) {
	    d._children = d.children;
	    d.children = null;
	  } else {
	    d.children = d._children;
	    d._children = null;
	  }
	  update();
	}
	
</script>
</div>
</body>
</html>